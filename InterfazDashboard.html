<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Gestión - Café Aroma</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CSS/EstilosDash.css">
    <script src="JS/desplazamientoPaginas.js" defer></script>
</head>
<body>
    <header class="header">
        <h1>☕ Café Aroma - Sistema de Gestión</h1>
        <nav>
            <button class="nav-btn active" onclick="mostrarSeccion('materia')">Materia Prima</button>
            <button class="nav-btn" onclick="mostrarSeccion('produccion')">Producción</button>
            <button class="nav-btn" onclick="mostrarSeccion('productos')">Productos Terminados</button>
            <button class="nav-btn" onclick="mostrarSeccion('pedidos')">Pedidos y Distribución</button>
            <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesión</button>
        </nav>
    </header>

    <main class="main-content">
        <section id="materia" class="section active">
            <h2>Gestión de Materia Prima</h2>
            <p>Registrar y actualizar información sobre granos verdes, controlar inventarios y generar órdenes de compra.</p>
            
            <div id="tablaStockBajo" class="mt-4"></div>
            <div id="tablaInventario" class="mt-4"></div>

            <button onclick="cargarInventario()" class="bg-green-600 text-white px-4 py-2 rounded mt-3 hover:bg-green-700">
                Actualizar Inventario
            </button>
        </section>

        <section id="produccion" class="section">
            <h2>Gestión de Producción de Empaques</h2>
            <p>Planificar y controlar procesos de teñido, tejido, corte y confección para costales, bolsas y empaques de café.</p>
    
            <div id="tablaMaterialesTextiles" class="mt-4"></div>
            <button onclick="cargarMaterialesTextiles()" class="bg-green-600 text-white px-4 py-2 rounded mt-3 hover:bg-green-700">
            Actualizar Materiales Textiles
            </button>

            <button onclick="mostrarFormularioLote()" class="bg-blue-600 text-white px-4 py-2 rounded mt-3 hover:bg-blue-700">
            Planificar Nuevo Lote
            </button>

            <div id="tablaLotes" class="mt-4"></div>
            <button onclick="cargarLotes()" class="bg-green-600 text-white px-4 py-2 rounded mt-3 hover:bg-green-700">
            Actualizar Lotes
            </button>

            <button onclick="generarReporteLotes()" class="bg-purple-600 text-white px-4 py-2 rounded mt-3 hover:bg-purple-700">
            Generar Reporte de Lotes
            </button>
            <div id="reporteLotes" class="mt-4"></div>
        </section>

        <section id="productos" class="section">
            <h2>Gestión de Productos Terminados</h2>
            <p>Registrar lotes terminados, controlar calidad mediante análisis de catación y preparar lotes para distribución.</p>
        
            <div id="tablaProductosTerminados" class="mt-4"></div>
            <button onclick="cargarProductosTerminados()" class="bg-green-600 text-white px-4 py-2 rounded mt-3 hover:bg-green-700">
            Actualizar Productos Terminados
            </button>

            <button onclick="mostrarFormularioLoteProducto()" class="bg-blue-600 text-white px-4 py-2 rounded mt-3 hover:bg-blue-700">
            Planificar Nuevo Lote
            </button>

            <div id="tablaLotesProductos" class="mt-4"></div>
            <button onclick="cargarLotesProductos()" class="bg-green-600 text-white px-4 py-2 rounded mt-3 hover:bg-green-700">
            Monitorear Lotes
            </button>

            <button onclick="generarReporteLotesProductos()" class="bg-purple-600 text-white px-4 py-2 rounded mt-3 hover:bg-purple-700">
            Generar Reporte de Lotes
            </button>
            <div id="reporteLotesProductos" class="mt-4"></div>
        </section>

        <section id="pedidos" class="section">
            <h2>Gestión de Pedidos y Distribución</h2>
            <p>Recibir pedidos, planificar rutas de entrega y monitorear las entregas en curso.</p>

            <button onclick="mostrarFormularioPedido()" class="bg-blue-600 text-white px-4 py-2 rounded mt-3 hover:bg-blue-700">
                Generar Pedido
            </button>

            <div id="tablaPedidos" class="mt-4"></div>

            <button onclick="cargarPedidos()" class="bg-green-600 text-white px-4 py-2 rounded mt-3 hover:bg-green-700">
                Actualizar Pedidos
            </button>
        </section>
    </main>

    <script>
        function mostrarSeccion(id) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function cerrarSesion() {
            window.location.href = "InterfazInicioRegistro.html";
        }

        async function cargarInventario() {
            try {
                const respuesta = await fetch('backend/api_inventario.php?action=inventario');
                const inventario = await respuesta.json();

                // Tabla de inventario completo
                let htmlInventario = `
                    <table class="table-auto border-collapse border border-gray-400 mt-4">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border px-4 py-2">Tipo de Grano</th>
                                <th class="border px-4 py-2">Cantidad (kg)</th>
                                <th class="border px-4 py-2">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // Tabla de stock bajo
                let htmlStockBajo = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                        <strong>Alerta:</strong> Los siguientes granos tienen stock bajo (< 20 kg). Se recomienda realizar un pedido.
                    </div>
                    <table class="table-auto border-collapse border border-red-400 mt-4">
                        <thead>
                            <tr class="bg-red-200">
                                <th class="border px-4 py-2">Tipo de Grano</th>
                                <th class="border px-4 py-2">Cantidad (kg)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let hayStockBajo = false;
                for (const tipo in inventario) {
                    const cantidad = inventario[tipo];
                    // Tabla de inventario completo
                    htmlInventario += `
                        <tr>
                            <td class="border px-4 py-2 text-center">${tipo}</td>
                            <td class="border px-4 py-2 text-center">${cantidad}</td>
                            <td class="border px-4 py-2 text-center">
                                <button onclick="mostrarFormularioAnadir('${tipo}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Añadir Cantidad</button>
                            </td>
                        </tr>
                    `;
                    // Tabla de stock bajo
                    if (cantidad < 20) {
                        hayStockBajo = true;
                        htmlStockBajo += `
                            <tr>
                                <td class="border px-4 py-2 text-center">${tipo}</td>
                                <td class="border px-4 py-2 text-center">${cantidad}</td>
                            </tr>
                        `;
                    }
                }

                htmlInventario += `</tbody></table>`;
                htmlStockBajo += `</tbody></table>`;

                // Mostrar tabla de stock bajo solo si hay granos con < 20 kg
                document.getElementById('tablaStockBajo').innerHTML = hayStockBajo ? htmlStockBajo : '';
                document.getElementById('tablaInventario').innerHTML = htmlInventario;

            } catch (error) {
                document.getElementById('tablaInventario').innerHTML =
                    `<p class="text-red-500">Error al cargar el inventario.</p>`;
                document.getElementById('tablaStockBajo').innerHTML = '';
                console.error(error);
            }
        }

        function mostrarFormularioAnadir(tipo) {
            const formulario = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
                    <div class="bg-white p-6 rounded shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Añadir Cantidad para ${tipo}</h3>
                        <form id="formAnadirGrano" class="space-y-4">
                            <input type="hidden" id="tipoGrano" value="${tipo}">
                            <div>
                                <label for="cantidadKg" class="block text-sm font-medium">Cantidad (kg)</label>
                                <input type="number" id="cantidadKg" name="cantidadKg" min="0" step="0.01" class="border rounded p-2 w-full" required>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button type="button" onclick="cerrarFormularioAnadir()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Añadir</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('tablaInventario').insertAdjacentHTML('beforeend', formulario);
        }

        function cerrarFormularioAnadir() {
            const formulario = document.querySelector('.fixed.inset-0');
            if (formulario) formulario.remove();
        }

        async function anadirCantidadGrano(event) {
            event.preventDefault();
            const tipo = document.getElementById('tipoGrano').value;
            const cantidad = parseFloat(document.getElementById('cantidadKg').value);

            if (!tipo || isNaN(cantidad) || cantidad < 0) {
                alert('Por favor, ingrese una cantidad válida en kilogramos.');
                return;
            }

            try {
                const respuesta = await fetch('backend/api_inventario.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'actualizar_stock', tipo, cantidad })
                });

                const resultado = await respuesta.json();
                if (respuesta.ok) {
                    alert('Cantidad añadida correctamente.');
                    cerrarFormularioAnadir();
                    cargarInventario();
                } else {
                    alert('Error: ' + resultado.error);
                }
            } catch (error) {
                alert('Error al añadir la cantidad.');
                console.error(error);
            }
        }

        function mostrarFormularioPedido() {
            const formulario = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
                    <div class="bg-white p-6 rounded shadow-lg w-1/2">
                        <h3 class="text-lg font-semibold mb-4">Generar Nuevo Pedido</h3>
                        <form id="formPedido" class="space-y-4">
                            <div id="detallesGranos" class="space-y-2">
                                <div class="grano-row flex space-x-2">
                                    <select name="tipoGrano" class="border rounded p-2 flex-1">
                                        <option value="Arábica">Arábica</option>
                                        <option value="Robusta">Robusta</option>
                                        <option value="Blend">Blend</option>
                                    </select>
                                    <input type="number" name="cantidad" min="0" step="0.1" placeholder="Cantidad (kg)" class="border rounded p-2 flex-1" required>
                                    <button type="button" onclick="eliminarGranoRow(this)" class="bg-red-500 text-white px-2 py-1 rounded">X</button>
                                </div>
                            </div>
                            <button type="button" onclick="añadirGranoRow()" class="bg-green-500 text-white px-4 py-2 rounded">Añadir Otro Grano</button>
                            <div class="flex justify-end space-x-2">
                                <button type="button" onclick="cerrarFormularioPedido()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Crear Pedido</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', formulario);
        }

        function cerrarFormularioPedido() {
            const formulario = document.querySelector('.fixed.inset-0');
            if (formulario) formulario.remove();
        }

        function añadirGranoRow() {
            const div = document.createElement('div');
            div.classList.add('grano-row', 'flex', 'space-x-2');
            div.innerHTML = `
                <select name="tipoGrano" class="border rounded p-2 flex-1">
                    <option value="Arábica">Arábica</option>
                    <option value="Robusta">Robusta</option>
                    <option value="Blend">Blend</option>
                </select>
                <input type="number" name="cantidad" min="0" step="0.1" placeholder="Cantidad (kg)" class="border rounded p-2 flex-1" required>
                <button type="button" onclick="eliminarGranoRow(this)" class="bg-red-500 text-white px-2 py-1 rounded">X</button>
            `;
            document.getElementById('detallesGranos').appendChild(div);
        }

        function eliminarGranoRow(btn) {
            btn.parentElement.remove();
        }

        async function crearPedido(event) {
            event.preventDefault();
            const rows = document.querySelectorAll('.grano-row');
            const detalles = {};
            rows.forEach(row => {
                const tipo = row.querySelector('[name="tipoGrano"]').value;
                const cantidad = parseFloat(row.querySelector('[name="cantidad"]').value);
                if (tipo && !isNaN(cantidad)) {
                    detalles[tipo] = (detalles[tipo] || 0) + cantidad;
                }
            });

            if (Object.keys(detalles).length === 0) {
                alert('Añade al menos un grano.');
                return;
            }

            try {
                const respuesta = await fetch('backend/api_inventario.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'crear_pedido', detalles })
                });
                const resultado = await respuesta.json();
                if (respuesta.ok) {
                    alert('Pedido creado correctamente.');
                    cerrarFormularioPedido();
                    cargarPedidos();
                } else {
                    alert('Error: ' + resultado.error);
                }
            } catch (error) {
                alert('Error al crear el pedido.');
                console.error(error);
            }
        }

        async function cargarPedidos() {
            try {
                const respuesta = await fetch('backend/api_inventario.php?action=pedidos');
                const pedidos = await respuesta.json();

                let html = `
                    <table class="table-auto border-collapse border border-gray-400 mt-4">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border px-4 py-2">Código</th>
                                <th class="border px-4 py-2">Fecha</th>
                                <th class="border px-4 py-2">Detalles</th>
                                <th class="border px-4 py-2">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const id in pedidos) {
                    const pedido = pedidos[id];
                    let detallesHtml = '';
                    for (const tipo in pedido.detalles) {
                        detallesHtml += `${tipo}: ${pedido.detalles[tipo]} kg<br>`;
                    }
                    html += `
                        <tr>
                            <td class="border px-4 py-2 text-center">${pedido.codigo_pedido}</td>
                            <td class="border px-4 py-2 text-center">${pedido.fecha}</td>
                            <td class="border px-4 py-2 text-center">${detallesHtml}</td>
                            <td class="border px-4 py-2 text-center">
                                <button onclick="marcarEntregado(${id})" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Marcar Entregado</button>
                            </td>
                        </tr>
                    `;
                }

                html += `</tbody></table>`;
                document.getElementById('tablaPedidos').innerHTML = html;

            } catch (error) {
                document.getElementById('tablaPedidos').innerHTML = `<p class="text-red-500">Error al cargar los pedidos.</p>`;
                console.error(error);
            }
        }

        async function marcarEntregado(id_pedido) {
            if (confirm('¿Marcar este pedido como entregado? Esto restará del inventario.')) {
                try {
                    const respuesta = await fetch('backend/api_inventario.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'marcar_entregado', id_pedido })
                    });
                    const resultado = await respuesta.json();
                    if (respuesta.ok) {
                        alert('Pedido entregado correctamente.');
                        cargarPedidos();
                        if (document.getElementById('materia').classList.contains('active')) {
                            cargarInventario();
                        }
                    } else {
                        alert('Error: ' + resultado.error);
                    }
                } catch (error) {
                    alert('Error al marcar el pedido.');
                    console.error(error);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            cargarInventario();
            cargarPedidos();
            document.getElementById('tablaInventario').addEventListener('submit', (e) => {
                if (e.target.id === 'formAnadirGrano') anadirCantidadGrano(e);
            });
            document.body.addEventListener('submit', (e) => {
                if (e.target.id === 'formPedido') crearPedido(e);
            });
        });

        async function cargarMaterialesTextiles() {
    try {
        const respuesta = await fetch('backend/api_produccion.php?action=materiales_textiles');
        const materiales = await respuesta.json();
        let html = `
            <table class="table-auto border-collapse border border-gray-400 mt-4">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border px-4 py-2">Tipo de Material</th>
                        <th class="border px-4 py-2">Cantidad (kg)</th>
                        <th class="border px-4 py-2">Acción</th>
                    </tr>
                </thead>
                <tbody>
        `;
        for (const tipo in materiales) {
            html += `
                <tr>
                    <td class="border px-4 py-2 text-center">${tipo}</td>
                    <td class="border px-4 py-2 text-center">${materiales[tipo]}</td>
                    <td class="border px-4 py-2 text-center">
                        <button onclick="mostrarFormularioAnadirTextil('${tipo}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Añadir</button>
                    </td>
                </tr>
            `;
        }
        html += `</tbody></table>`;
        document.getElementById('tablaMaterialesTextiles').innerHTML = html;
    } catch (error) {
        console.error(error);
    }
}

function mostrarFormularioAnadirTextil(tipo) {
    // Similar a mostrarFormularioAnadir, pero para textiles
    const formulario = `
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
            <div class="bg-white p-6 rounded shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Añadir Cantidad para ${tipo}</h3>
                <form id="formAnadirTextil" class="space-y-4">
                    <input type="hidden" id="tipoTextil" value="${tipo}">
                    <div>
                        <label for="cantidadKgTextil" class="block text-sm font-medium">Cantidad (kg)</label>
                        <input type="number" id="cantidadKgTextil" name="cantidadKgTextil" min="0" step="0.01" class="border rounded p-2 w-full" required>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="cerrarFormularioAnadirTextil()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Añadir</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', formulario);
    document.getElementById('formAnadirTextil').addEventListener('submit', anadirCantidadTextil);
}

function cerrarFormularioAnadirTextil() {
    const formulario = document.querySelector('.fixed.inset-0');
    if (formulario) formulario.remove();
}

async function anadirCantidadTextil(event) {
    event.preventDefault();
    const tipo = document.getElementById('tipoTextil').value;
    const cantidad = parseFloat(document.getElementById('cantidadKgTextil').value);
    try {
        const respuesta = await fetch('backend/api_produccion.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'actualizar_stock_textil', tipo, cantidad })
        });
        const resultado = await respuesta.json();
        if (respuesta.ok) {
            alert('Cantidad añadida.');
            cerrarFormularioAnadirTextil();
            cargarMaterialesTextiles();
        } else {
            alert('Error: ' + resultado.error);
        }
    } catch (error) {
        console.error(error);
    }
}

function mostrarFormularioLote() {
    const formulario = `
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
            <div class="bg-white p-6 rounded shadow-lg w-1/2">
                <h3 class="text-lg font-semibold mb-4">Planificar Nuevo Lote</h3>
                <form id="formLote" class="space-y-4">
                    <div>
                        <label for="tipoEmpaque">Tipo de Empaque</label>
                        <input type="text" id="tipoEmpaque" placeholder="e.g., Costal de Yute 50kg" class="border rounded p-2 w-full" required>
                    </div>
                    <div>
                        <label for="cantidadPlaneada">Cantidad Planeada (unidades)</label>
                        <input type="number" id="cantidadPlaneada" min="1" class="border rounded p-2 w-full" required>
                    </div>
                    <div>
                        <label>Procesos a Incluir</label>
                        <div class="space-y-2">
                            <label><input type="checkbox" name="procesos" value="tejido"> Tejido</label>
                            <label><input type="checkbox" name="procesos" value="teñido"> Teñido</label>
                            <label><input type="checkbox" name="procesos" value="corte"> Corte</label>
                            <label><input type="checkbox" name="procesos" value="confeccion"> Confección</label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="cerrarFormularioLote()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Crear Lote</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', formulario);
    document.getElementById('formLote').addEventListener('submit', crearLote);
}

function cerrarFormularioLote() {
    const formulario = document.querySelector('.fixed.inset-0');
    if (formulario) formulario.remove();
}

async function crearLote(event) {
    event.preventDefault();
    const tipo_empaque = document.getElementById('tipoEmpaque').value;
    const cantidad_planeada = parseInt(document.getElementById('cantidadPlaneada').value);
    const procesos = Array.from(document.querySelectorAll('[name="procesos"]:checked')).map(cb => cb.value);
    try {
        const respuesta = await fetch('backend/api_produccion.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'crear_lote', tipo_empaque, cantidad_planeada, procesos })
        });
        const resultado = await respuesta.json();
        if (respuesta.ok) {
            alert('Lote planeado correctamente.');
            cerrarFormularioLote();
            cargarLotes();
        } else {
            alert('Error: ' + resultado.error);
        }
    } catch (error) {
        console.error(error);
    }
}

async function cargarLotes() {
    try {
        const respuesta = await fetch('backend/api_produccion.php?action=lotes');
        const lotes = await respuesta.json();
        let html = `
            <table class="table-auto border-collapse border border-gray-400 mt-4">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border px-4 py-2">Código</th>
                        <th class="border px-4 py-2">Tipo Empaque</th>
                        <th class="border px-4 py-2">Cantidad Planeada</th>
                        <th class="border px-4 py-2">Estado</th>
                        <th class="border px-4 py-2">Procesos</th>
                    </tr>
                </thead>
                <tbody>
        `;
        for (const id in lotes) {
            const lote = lotes[id];
            let procesosHtml = '';
            lote.procesos.forEach(p => {
                procesosHtml += `${p.proceso}: ${p.cantidad_procesada || 0} procesado ${p.fecha_completado ? '(Completado)' : '<button onclick="completarProceso(' + id + ', \'' + p.proceso + '\')">Completar</button>'}<br>`;
            });
            html += `
                <tr>
                    <td class="border px-4 py-2 text-center">${lote.codigo_lote}</td>
                    <td class="border px-4 py-2 text-center">${lote.tipo_empaque}</td>
                    <td class="border px-4 py-2 text-center">${lote.cantidad_planeada}</td>
                    <td class="border px-4 py-2 text-center">${lote.estado}</td>
                    <td class="border px-4 py-2 text-center">${procesosHtml}</td>
                </tr>
            `;
        }
        html += `</tbody></table>`;
        document.getElementById('tablaLotes').innerHTML = html;
    } catch (error) {
        console.error(error);
    }
}

async function completarProceso(id_lote, proceso) {
    const cantidad_procesada = prompt('Ingrese cantidad procesada:');
    if (cantidad_procesada) {
        try {
            const respuesta = await fetch('backend/api_produccion.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'completar_proceso', id_lote, proceso, cantidad_procesada: parseFloat(cantidad_procesada) })
            });
            const resultado = await respuesta.json();
            if (respuesta.ok) {
                alert('Proceso completado.');
                cargarLotes();
            } else {
                alert('Error: ' + resultado.error);
            }
        } catch (error) {
            console.error(error);
        }
    }
}

async function generarReporteLotes() {
    try {
        const respuesta = await fetch('backend/api_produccion.php?action=reporte_lotes');
        const reporte = await respuesta.json();
        let html = `
            <table class="table-auto border-collapse border border-purple-400 mt-4">
                <thead>
                    <tr class="bg-purple-100">
                        <th class="border px-4 py-2">Código</th>
                        <th class="border px-4 py-2">Tipo</th>
                        <th class="border px-4 py-2">Cantidad</th>
                        <th class="border px-4 py-2">Estado</th>
                        <th class="border px-4 py-2">Fecha Inicio</th>
                        <th class="border px-4 py-2">Fecha Fin</th>
                    </tr>
                </thead>
                <tbody>
        `;
        reporte.forEach(r => {
            html += `
                <tr>
                    <td class="border px-4 py-2 text-center">${r.codigo_lote}</td>
                    <td class="border px-4 py-2 text-center">${r.tipo_empaque}</td>
                    <td class="border px-4 py-2 text-center">${r.cantidad_planeada}</td>
                    <td class="border px-4 py-2 text-center">${r.estado}</td>
                    <td class="border px-4 py-2 text-center">${r.fecha_inicio || 'N/A'}</td>
                    <td class="border px-4 py-2 text-center">${r.fecha_fin || 'N/A'}</td>
                </tr>
            `;
        });
        html += `</tbody></table>`;
        document.getElementById('reporteLotes').innerHTML = html;
    } catch (error) {
        console.error(error);
    }
}

// Cargar inicial
document.addEventListener('DOMContentLoaded', () => {
    // ... código existente ...
    if (document.getElementById('produccion').classList.contains('active')) {
        cargarMaterialesTextiles();
        cargarLotes();
    }
});

async function cargarProductosTerminados() {
    try {
        const respuesta = await fetch('backend/api_productos.php?action=productos_terminados');
        const productos = await respuesta.json();
        let html = `
            <table class="table-auto border-collapse border border-gray-400 mt-4">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border px-4 py-2">Tipo de Café</th>
                        <th class="border px-4 py-2">Cantidad (kg)</th>
                        <th class="border px-4 py-2">Acción</th>
                    </tr>
                </thead>
                <tbody>
        `;
        for (const tipo in productos) {
            html += `
                <tr>
                    <td class="border px-4 py-2 text-center">${tipo}</td>
                    <td class="border px-4 py-2 text-center">${productos[tipo]}</td>
                    <td class="border px-4 py-2 text-center">
                        <button onclick="mostrarFormularioAnadirProducto('${tipo}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Añadir</button>
                    </td>
                </tr>
            `;
        }
        html += `</tbody></table>`;
        document.getElementById('tablaProductosTerminados').innerHTML = html;
    } catch (error) {
        console.error(error);
    }
}

function mostrarFormularioAnadirProducto(tipo) {
    const formulario = `
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
            <div class="bg-white p-6 rounded shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Añadir Cantidad para ${tipo}</h3>
                <form id="formAnadirProducto" class="space-y-4">
                    <input type="hidden" id="tipoProducto" value="${tipo}">
                    <div>
                        <label for="cantidadKgProducto" class="block text-sm font-medium">Cantidad (kg)</label>
                        <input type="number" id="cantidadKgProducto" name="cantidadKgProducto" min="0" step="0.01" class="border rounded p-2 w-full" required>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="cerrarFormularioAnadirProducto()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Añadir</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', formulario);
    document.getElementById('formAnadirProducto').addEventListener('submit', anadirCantidadProducto);
}

function cerrarFormularioAnadirProducto() {
    const formulario = document.querySelector('.fixed.inset-0');
    if (formulario) formulario.remove();
}

async function anadirCantidadProducto(event) {
    event.preventDefault();
    const tipo = document.getElementById('tipoProducto').value;
    const cantidad = parseFloat(document.getElementById('cantidadKgProducto').value);
    try {
        const respuesta = await fetch('backend/api_productos.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'actualizar_stock_producto', tipo, cantidad })
        });
        const resultado = await respuesta.json();
        if (respuesta.ok) {
            alert('Cantidad añadida.');
            cerrarFormularioAnadirProducto();
            cargarProductosTerminados();
        } else {
            alert('Error: ' + resultado.error);
        }
    } catch (error) {
        console.error(error);
    }
}

function mostrarFormularioLoteProducto() {
    const formulario = `
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
            <div class="bg-white p-6 rounded shadow-lg w-1/2">
                <h3 class="text-lg font-semibold mb-4">Planificar Nuevo Lote de Producto</h3>
                <form id="formLoteProducto" class="space-y-4">
                    <div>
                        <label for="tipoCafe">Tipo de Café</label>
                        <input type="text" id="tipoCafe" placeholder="e.g., Arábica Tostado Molido Fino" class="border rounded p-2 w-full" required>
                    </div>
                    <div>
                        <label for="cantidadPlaneadaProducto">Cantidad Planeada (kg)</label>
                        <input type="number" id="cantidadPlaneadaProducto" min="1" step="0.1" class="border rounded p-2 w-full" required>
                    </div>
                    <div>
                        <label>Procesos a Incluir</label>
                        <div class="space-y-2">
                            <label><input type="checkbox" name="procesosProducto" value="tostado"> Tostado</label>
                            <label><input type="checkbox" name="procesosProducto" value="molido"> Molido</label>
                            <label><input type="checkbox" name="procesosProducto" value="envasado"> Envasado</label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="cerrarFormularioLoteProducto()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Crear Lote</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', formulario);
    document.getElementById('formLoteProducto').addEventListener('submit', crearLoteProducto);
}

function cerrarFormularioLoteProducto() {
    const formulario = document.querySelector('.fixed.inset-0');
    if (formulario) formulario.remove();
}

async function crearLoteProducto(event) {
    event.preventDefault();
    const tipo_cafe = document.getElementById('tipoCafe').value;
    const cantidad_planeada = parseFloat(document.getElementById('cantidadPlaneadaProducto').value);
    const procesos = Array.from(document.querySelectorAll('[name="procesosProducto"]:checked')).map(cb => cb.value);
    try {
        const respuesta = await fetch('backend/api_productos.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'crear_lote', tipo_cafe, cantidad_planeada, procesos })
        });
        const resultado = await respuesta.json();
        if (respuesta.ok) {
            alert('Lote planeado correctamente.');
            cerrarFormularioLoteProducto();
            cargarLotesProductos();
        } else {
            alert('Error: ' + resultado.error);
        }
    } catch (error) {
        console.error(error);
    }
}

async function cargarLotesProductos() {
    try {
        const respuesta = await fetch('backend/api_productos.php?action=lotes');
        const lotes = await respuesta.json();
        let html = `
            <table class="table-auto border-collapse border border-gray-400 mt-4">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border px-4 py-2">Código</th>
                        <th class="border px-4 py-2">Tipo Café</th>
                        <th class="border px-4 py-2">Cantidad (kg)</th>
                        <th class="border px-4 py-2">Estado</th>
                        <th class="border px-4 py-2">Vencimiento</th>
                        <th class="border px-4 py-2">Procesos</th>
                    </tr>
                </thead>
                <tbody>
        `;
        for (const id in lotes) {
            const lote = lotes[id];
            let procesosHtml = '';
            lote.procesos.forEach(p => {
                procesosHtml += `${p.proceso}: ${p.cantidad_procesada || 0} procesado ${p.fecha_completado ? '(Completado)' : '<button onclick="completarProcesoProducto(' + id + ', \'' + p.proceso + '\')">Completar</button>'}<br>`;
            });
            html += `
                <tr>
                    <td class="border px-4 py-2 text-center">${lote.codigo_lote}</td>
                    <td class="border px-4 py-2 text-center">${lote.tipo_cafe}</td>
                    <td class="border px-4 py-2 text-center">${lote.cantidad_kg}</td>
                    <td class="border px-4 py-2 text-center">${lote.estado}</td>
                    <td class="border px-4 py-2 text-center">${lote.fecha_vencimiento}</td>
                    <td class="border px-4 py-2 text-center">${procesosHtml}</td>
                </tr>
            `;
        }
        html += `</tbody></table>`;
        document.getElementById('tablaLotesProductos').innerHTML = html;
    } catch (error) {
        console.error(error);
    }
}

async function completarProcesoProducto(id_lote, proceso) {
    const cantidad_procesada = prompt('Ingrese cantidad procesada (kg):');
    if (cantidad_procesada) {
        try {
            const respuesta = await fetch('backend/api_productos.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'completar_proceso', id_lote, proceso, cantidad_procesada: parseFloat(cantidad_procesada) })
            });
            const resultado = await respuesta.json();
            if (respuesta.ok) {
                alert('Proceso completado.');
                cargarLotesProductos();
                cargarProductosTerminados();  // Actualizar inventario si se completa el lote
            } else {
                alert('Error: ' + resultado.error);
            }
        } catch (error) {
            console.error(error);
        }
    }
}

async function generarReporteLotesProductos() {
    try {
        const respuesta = await fetch('backend/api_productos.php?action=reporte_lotes');
        const reporte = await respuesta.json();
        let html = `
            <table class="table-auto border-collapse border border-purple-400 mt-4">
                <thead>
                    <tr class="bg-purple-100">
                        <th class="border px-4 py-2">Código</th>
                        <th class="border px-4 py-2">Tipo</th>
                        <th class="border px-4 py-2">Cantidad (kg)</th>
                        <th class="border px-4 py-2">Estado</th>
                        <th class="border px-4 py-2">Producción</th>
                        <th class="border px-4 py-2">Vencimiento</th>
                    </tr>
                </thead>
                <tbody>
        `;
        reporte.forEach(r => {
            html += `
                <tr>
                    <td class="border px-4 py-2 text-center">${r.codigo_lote}</td>
                    <td class="border px-4 py-2 text-center">${r.tipo_cafe}</td>
                    <td class="border px-4 py-2 text-center">${r.cantidad_kg}</td>
                    <td class="border px-4 py-2 text-center">${r.estado}</td>
                    <td class="border px-4 py-2 text-center">${r.fecha_produccion || 'N/A'}</td>
                    <td class="border px-4 py-2 text-center">${r.fecha_vencimiento || 'N/A'}</td>
                </tr>
            `;
        });
        html += `</tbody></table>`;
        document.getElementById('reporteLotesProductos').innerHTML = html;
    } catch (error) {
        console.error(error);
    }
}

// Cargar inicial al entrar en la sección
document.addEventListener('DOMContentLoaded', () => {
    // ... código existente ...
    if (document.getElementById('productos').classList.contains('active')) {
        cargarProductosTerminados();
        cargarLotesProductos();
    }
});

    </script>
</body>
</html>