<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Gestión - Café Aroma</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CSS/EstilosDash.css">
    <script src="JS/desplazamientoPaginas.js" defer></script>
</head>
<body>
    <header class="header">
        <h1>☕ Café Aroma - Sistema de Gestión</h1>
        <nav>
            <button class="nav-btn active" onclick="mostrarSeccion('materia')">Materia Prima</button>
            <button class="nav-btn" onclick="mostrarSeccion('produccion')">Producción</button>
            <button class="nav-btn" onclick="mostrarSeccion('productos')">Productos Terminados</button>
            <button class="nav-btn" onclick="mostrarSeccion('pedidos')">Pedidos y Distribución</button>
            <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesión</button>
        </nav>
    </header>

    <main class="main-content">
        <section id="materia" class="section active">
            <h2>Gestión de Materia Prima</h2>
            <p>Registrar y actualizar información sobre granos verdes, controlar inventarios y generar órdenes de compra.</p>
            
            <div id="tablaInventario" class="mt-4"></div>

            <!-- Botón para recargar datos -->
            <button onclick="cargarInventario()" class="bg-green-600 text-white px-4 py-2 rounded mt-3 hover:bg-green-700">
                Actualizar Inventario
            </button>
        </section>

        <section id="produccion" class="section">
            <h2>Gestión de Producción</h2>
            <p>Planificar y controlar los procesos de tostado, molienda y envasado del café gourmet.</p>
        </section>

        <section id="productos" class="section">
            <h2>Gestión de Productos Terminados</h2>
            <p>Registrar lotes terminados, controlar calidad mediante análisis de catación y preparar lotes para distribución.</p>
        </section>

        <section id="pedidos" class="section">
            <h2>Gestión de Pedidos y Distribución</h2>
            <p>Recibir pedidos, planificar rutas de entrega y monitorear las entregas en curso.</p>
        </section>
    </main>

    <script>
        function mostrarSeccion(id) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function cerrarSesion() {
            window.location.href = "InterfazInicioRegistro.html"; // Regresa al login
        }

        async function cargarInventario() {
            try {
                const respuesta = await fetch('backend/api_inventario.php');
                const inventario = await respuesta.json();

                let html = `
                    <table class="table-auto border-collapse border border-gray-400 mt-4">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border px-4 py-2">Tipo de Grano</th>
                                <th class="border px-4 py-2">Cantidad (kg)</th>
                                <th class="border px-4 py-2">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const tipo in inventario) {
                    html += `
                        <tr>
                            <td class="border px-4 py-2 text-center">${tipo}</td>
                            <td class="border px-4 py-2 text-center">${inventario[tipo]}</td>
                            <td class="border px-4 py-2 text-center">
                                <button onclick="mostrarFormularioAnadir('${tipo}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Añadir Cantidad</button>
                            </td>
                        </tr>
                    `;
                }

                html += `</tbody></table>`;
                document.getElementById('tablaInventario').innerHTML = html;

            } catch (error) {
                document.getElementById('tablaInventario').innerHTML =
                    `<p class="text-red-500">Error al cargar el inventario.</p>`;
                console.error(error);
            }
        }

        function mostrarFormularioAnadir(tipo) {
            const formulario = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
                    <div class="bg-white p-6 rounded shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Añadir Cantidad para ${tipo}</h3>
                        <form id="formAnadirGrano" class="space-y-4">
                            <input type="hidden" id="tipoGrano" value="${tipo}">
                            <div>
                                <label for="cantidadKg" class="block text-sm font-medium">Cantidad (kg)</label>
                                <input type="number" id="cantidadKg" name="cantidadKg" min="0" step="0.01" class="border rounded p-2 w-full" required>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button type="button" onclick="cerrarFormularioAnadir()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Añadir</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('tablaInventario').insertAdjacentHTML('beforeend', formulario);
        }

        function cerrarFormularioAnadir() {
            const formulario = document.querySelector('.fixed.inset-0');
            if (formulario) formulario.remove();
        }

        async function anadirCantidadGrano(event) {
            event.preventDefault();
            const tipo = document.getElementById('tipoGrano').value;
            const cantidad = parseFloat(document.getElementById('cantidadKg').value);

            if (!tipo || isNaN(cantidad) || cantidad < 0) {
                alert('Por favor, ingrese una cantidad válida en kilogramos.');
                return;
            }

            try {
                const respuesta = await fetch('backend/api_inventario.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tipo, cantidad })
                });

                const resultado = await respuesta.json();
                if (respuesta.ok) {
                    alert('Cantidad añadida correctamente.');
                    cerrarFormularioAnadir();
                    cargarInventario();
                } else {
                    alert('Error: ' + resultado.error);
                }
            } catch (error) {
                alert('Error al añadir la cantidad.');
                console.error(error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            cargarInventario();
            document.getElementById('tablaInventario').addEventListener('submit', (e) => {
                if (e.target.id === 'formAnadirGrano') anadirCantidadGrano(e);
            });
        });
    </script>
</body>
</html>